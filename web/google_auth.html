<html>
    <head>
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
      <script async defer src="https://apis.google.com/js/api.js"
              onload="this.onload=function(){};handleClientLoad()"
              onreadystatechange="if (this.readyState === 'complete') this.onload()">
      </script>
     
    </head>
    <body>

        <button id="sign-in-or-out-button">Sign In/Authorize</button>
        <div id="auth-status" style="display: inline; padding-left: 25px"></div>
         <script>
          var GoogleAuth;
          const BACKEND_KEY = 'swiftlatex_storage_backend';
          var SCOPE = 'https://www.googleapis.com/auth/drive.file';
          function handleClientLoad() {
            // Load the API's client and auth2 modules.
            // Call the initClient function after the modules load.
            gapi.load('client:auth2', initClient);
          }

          function initClient() {
            // Retrieve the discovery document for version 3 of Google Drive API.

            // In practice, your app can retrieve one or more discovery documents.
            var discoveryUrl = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';

            // Initialize the gapi.client object, which app uses to make API requests.
            // Get API key and client ID from API Console.
            // 'scope' field specifies space-delimited list of access scopes.
            gapi.client.init({
                'apiKey': 'AIzaSyBl1LNH7Hgl6ZvyxynB0Wkx48aeJixWDrM',
                'discoveryDocs': [discoveryUrl],
                'clientId': '691913119884-481fqunn0n41a86p7rv1g4aqrr3t1dmr.apps.googleusercontent.com',
                'scope': SCOPE
            }).then(function () {
              GoogleAuth = gapi.auth2.getAuthInstance();

              // Listen for sign-in state changes.
              GoogleAuth.isSignedIn.listen(updateSigninStatus);

              setSigninStatus();

              // Call handleAuthClick function when user clicks on
              //      "Sign In/Authorize" button.
              $('#sign-in-or-out-button').click(function() {
                handleAuthClick();
              });
              
            });
          }

          function handleAuthClick() {
               if (GoogleAuth.isSignedIn.get()) {
                  // User is authorized and has clicked 'Sign out' button.
                  GoogleAuth.signOut();
                  localStorage.removeItem(BACKEND_KEY);
                } else {
                  // User is not signed in. Start Google auth flow.
                  GoogleAuth.signIn();
                }
          }

          function setSigninStatus(isSignedIn) {
            var user = GoogleAuth.currentUser.get();
            var isAuthorized = user.hasGrantedScopes(SCOPE);
            if (isAuthorized) {
                $('#sign-in-or-out-button').html('Revoke!');
                $('#auth-status').html('Access granted, redirecting to SwiftLaTeX in a few seconds...');
                localStorage.setItem(BACKEND_KEY, 'google');
                setTimeout(function(){
                  window.location.href = "/";
                }, 3000);
            } else {
              $('#sign-in-or-out-button').html('Sign In/Authorize');
              $('#auth-status').html('Please click to sign in your Google drive.');
            }
          }

          function updateSigninStatus(isSignedIn) {
            setSigninStatus();
          }
        </script>
    </body>
</html>





